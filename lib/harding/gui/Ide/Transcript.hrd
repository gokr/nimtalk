# ============================================================================
# IdeTranscript - Output stream for the IDE
# Similar to Smalltalk's Transcript, provides logging and output
# Now using GtkSourceView for text display (read-only)
# ============================================================================

Transcript := Object derive: #(window box scrolledWindow sourceView owner)

Transcript>>initialize [
  window := nil.
  sourceView := nil.
  owner := nil.
  ^ self
]

Transcript>>show: anObject [
  # Append anObject's printString to the transcript.
  sourceView notNil ifTrue: [
    sourceView insertTextAtEnd: (anObject printString).
    self scrollToBottom
  ]
]

Transcript>>showCr: anObject [
  # Append anObject's printString followed by a newline.
  sourceView notNil ifTrue: [
    sourceView insertTextAtEnd: (anObject printString).
    sourceView insertTextAtEnd: "\n".
    self scrollToBottom
  ]
]

Transcript>>showSpace: anObject [
  # Append anObject's printString followed by a space.
  sourceView notNil ifTrue: [
    sourceView insertTextAtEnd: (anObject printString).
    sourceView insertTextAtEnd: " ".
    self scrollToBottom
  ]
]

Transcript>>cr [
  # Append a newline (carriage return) to the transcript.
  sourceView notNil ifTrue: [
    sourceView insertTextAtEnd: "\n".
    self scrollToBottom
  ]
]

Transcript>>tab [
  # Append a tab character to the transcript.
  sourceView notNil ifTrue: [
    sourceView insertTextAtEnd: "\t".
    self scrollToBottom
  ]
]

Transcript>>clear [
  sourceView notNil ifTrue: [
    sourceView text: ""
  ]
]

Transcript>>contents [
  sourceView notNil ifTrue: [
    ^ sourceView text
  ].
  ^ ""
]

Transcript>>scrollToBottom [
  # Auto-scroll to show the newest content
  sourceView notNil ifTrue: [
    sourceView scrollToEnd
  ]
]

Transcript>>checkSourceView [
  # Debug method to see which sourceView we're using
  sourceView notNil ifTrue: [
    ^ ("Transcript sourceView: ", sourceView text firstLine)
  ].
  ^ "Transcript sourceView: nil"
]

Transcript>>openWindowFor: anOwner [
  | mainBox buttonBox clearButton |

  window := GtkWindow new.
  window title: "Transcript".
  window iconName: "harding".
  owner := anOwner.


  # Create vertical box layout
  mainBox := GtkBox vertical.
  mainBox setSpacing: 5.

  # Create scrolled window for source view
  scrolledWindow := GtkScrolledWindow new.
  scrolledWindow vexpand: true.
  scrolledWindow hexpand: true.

  # Create source view (read-only text display)
  sourceView := GtkSourceView new.
  sourceView showLineNumbers: true.
  sourceView setTabWidth: 2.
  sourceView vexpand: true.
  sourceView hexpand: true.
  sourceView editable: false.  # Read-only

  # Create button box with Clear button
  buttonBox := GtkBox horizontal.
  buttonBox setSpacing: 5.

  clearButton := GtkButton newLabel: "Clear".
  clearButton clicked: [ self clear ].
  buttonBox append: clearButton.

  # Assemble the UI
  window setChild: mainBox.
  mainBox append: scrolledWindow.
  scrolledWindow setChild: sourceView.
  mainBox append: buttonBox.

  # Install keyboard shortcuts (Ctrl+D for Do It on selection)
  self installKeyboardShortcuts.

  # Connect destroy signal to notify owner
  window destroyed: [ self onDestroy ].

  # Register with owner
  anOwner notNil ifTrue: [ anOwner addWindow: self ].

  window present.
  ^ self
]

Transcript>>openWindow [
  ^ self openWindowFor: nil
]

Transcript>>installKeyboardShortcuts [
  # Install Ctrl+D for Do It (evaluate selected text)
  sourceView enableKeyboardShortcuts.
  sourceView onControlKey: "d" do: [ self doItSelection ]
]

Transcript>>doItSelection [
  # Do It - evaluate selected text
  | code result |
  code := sourceView selectedText.
  code isEmpty not ifTrue: [
    result := Object eval: code.
    self showCr: result printString.
    ^ result
  ].
  ^ nil
]

Transcript>>onDestroy [
  window := nil.
  sourceView := nil.
  owner notNil ifTrue: [
    owner removeWindow: self.
    owner := nil
  ]
]

# Create the singleton instance at load time
CurrentTranscript := Transcript new.
CurrentTranscript initialize.

# Class-side convenience methods that delegate to the singleton instance
Transcript class>>current [
  ^ CurrentTranscript
]

Transcript class>>open [
  ^ self current openWindow
]

Transcript class>>openFor: anOwner [
  ^ self current openWindowFor: anOwner
]

Transcript class>>show: anObject [
  ^ self current show: anObject
]

Transcript class>>showCr: anObject [
  ^ self current showCr: anObject
]

Transcript class>>showSpace: anObject [
  ^ self current showSpace: anObject
]

Transcript class>>cr [
  ^ self current cr
]

Transcript class>>tab [
  ^ self current tab
]

Transcript class>>clear [
  ^ self current clear
]
