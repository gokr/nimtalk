#!/usr/bin/env ntalk
#
# Object.nt - Root object with core methods
# This is the foundation of the Nimtalk object system

# Object is the root of the prototype hierarchy
# It provides fundamental behaviors that all objects inherit

Object := nil  # Will be set to the root object by the interpreter

#====================================================================
# Object creation and copying
#====================================================================

Object>>clone [
  "Create a shallow copy of this object without prototype links.
   The copy has no parents and shares property/method dictionaries."
  ^ self perform: 'primitiveClone'
].

Object>>derive [
  "Create a child object with this object as its parent.
   The child inherits behavior through the prototype chain."
  ^ self perform: 'primitiveDerive'
].

Object>>derive: ivarArray [
  "Create a child with declared instance variables.
   ivarArray should be an array of symbols like #(name age address)."
  ^ self perform: 'primitiveDeriveWithIVars:' with: ivarArray
].

#====================================================================
# Property access
#====================================================================

Object>>at: key [
  "Get the value of a property. Searches the object and its prototype chain."
  ^ self perform: 'primitiveAt:' with: key
].

Object>>at: key put: value [
  "Set a property value on this object (not in prototypes)."
  ^ self perform: 'primitiveAt:put:' with: key with: value
].

Object>>hasProperty: key [
  "Check if this object directly has a property (not in parents)."
  ^ self perform: 'primitiveHasProperty:' with: key
].

Object>>properties [
  "Return a collection of all property keys on this object."
  ^ self perform: 'primitiveProperties'
].

#====================================================================
# Method management
#====================================================================

Object>>respondsTo: selector [
  "Check if this object or its prototype chain responds to a message."
  ^ self perform: 'primitiveRespondsTo:' with: selector
].

Object>>methods [
  "Return a collection of all method selectors on this object."
  ^ self perform: 'primitiveMethods'
].

Object>>doesNotUnderstand: message [
  "Default handler for unrecognized messages.
   Subclasses can override to provide custom behavior."
  self error: 'Message not understood: ' + message asString
].

#====================================================================
# Identity and comparison
#====================================================================

Object>>== other [
  "Test if this object is the same object as other (identity)."
  ^ self perform: 'primitiveEquals:' with: other
].

Object>>printString [
  "Return a string representation of this object."
  ^ '<' + (self className) + '>'
].

Object>>className [
  "Return the class name of this object."
  | tags |
  tags := self at: 'tags'.
  tags isNil
    ifTrue: [ ^ 'Object' ]
    ifFalse: [ ^ tags first ]
].

#====================================================================
# Error handling
#====================================================================

Object>>error: message [
  "Signal an error with the given message."
  self perform: 'primitiveError:' with: message
].

#====================================================================
# Testing and debugging
#====================================================================

Object>>inspect [
  "Open an inspector on this object. (placeholder)"
  self printString print
].

Object>>yourself [
  "Return self - useful for cascading messages."
  ^ self
].

#====================================================================
# Initialization
#====================================================================

Object>>initialize [
  "Initialize a new instance. Subclasses should override."
  ^ self
].

#====================================================================
# Utility methods
#====================================================================

Object>>isNil [
  "Check if object is nil"
  ^ self == nil
].

Object>>notNil [
  "Check if object is not nil"
  ^ self isNil not
].

Object>>class [
  "Return the class/prototype of this object"
  | tags |
  tags := self at: 'tags'.
  tags isNil ifTrue: [ ^ Object ].
  ^ Global at: (tags first) ifAbsent: [ Object ]
].

Object>>isKindOf: aClass [
  "Check if object is kind of aClass (in prototype chain)"
  ^ self perform: 'primitiveIsKindOf:' with: aClass
].

Object>>asString [
  "Return string representation"
  ^ self printString
].

Object>>print [
  "Print to stdout without newline"
  Stdout write: self printString
].

Object>>println [
  "Print to stdout with newline"
  Stdout writeline: self printString
].

#====================================================================
# Comparison
#====================================================================

Object>>~= other [
  "Not equal - delegates to = and negates"
  ^ (self = other) not
].

Object>>== other [
  "Identity comparison - true if same object"
  ^ self perform: 'primitiveIdentity:' with: other
].

Object>>~~ other [
  "Not identity - true if different objects"
  ^ (self == other) not
].
